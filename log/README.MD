
## 静态资源使用日志统计与处理说明

### 说明

基于统计的静态资源自动合并的核心就在于统计页面静态资源的主要使用情况。例如一个页面加载过程中使用了什么资源，使用的资源组合顺序是什么。如果资源组合顺序不同，可以认为这是一个新的“页面”，因为基于统计的自动打包就是要解决资源在不同使用组合情况下的优化合并方案。

### 统计注意点

**统计方式**

一般统计是在资源调用的地方加上统计钩子，标记资源在某个页面被使用，最后把这个页面按调用顺序使用的所有资源生成一条统计日志发送给日志服务器。注意统计日志要使用**hash来标识资源**，否则可能因为日志过长而被截断。

统计脚本可以借助后端或者前端代码，例如FIS的smarty解决方案中，借助了后端来管理静态资源，调用静态资源的方式也是通过smarty标签，这样在smarty自定义标签里添加统计代码即可，具体见`statistics`中示例。

**资源组合hash**

统计日志中应当添加hash来标示资源使用组合，即将所有使用的静态资源进行hash计算，最终计算自动打包时这个hash就相当于一个“页面”。


**基础文件的统计**

部分诸如requirejs之类的资源可能不方便直接在钩子中统计使用次数，因为是直接通过script标签加载。这种情况下可以不用处理，在调用自动打包方法时将这些js填入到基础脚本配置项即可。

如：

```js

var files= ... ;
var result = autoPackger.pack(files,{
    'baseResources' : ['require.js','/static/lib/jquery.js'] //可以写全路径或者文件名
});

```

**统计抽样**

如果网站PV较高，可以采取抽样统计的方式，只要能比较客观的统计到整站静态资源的使用情况即可。


### 日志处理

日志的处理是将原始日志进行分割合并，方便后续计算资源在各种组合情况下是的使用次数。

#### 日志切割

对于前端开发人员来说，本地使用NodeJS就可以轻松搞定百万级别的日志处理，可以参考`process`里面的处理脚本(不能直接运行，仅为示例)。

当然即便是海量日志处理(多个产品线数据)，也可以使用NodeJS编写hadoop脚本来实现，只要将脚本稍加改造即可，这里不做详述。

#### 日志与文件的对应

**日志hash与文件的对应**

由于日志统计使用了文件hash，因此在分析代码时需要将日志hash跟文件对应上才能获取到资源的使用次数。


**依赖的对应**

统计的资源可能是网站的部分资源，对于已统计到的资源如果通过代码分析计算到还同步或者异步依赖了其他资源，那么需要将对应依赖的资源也加上相应的使用次数。

**文件是同步还是异步的判断**

同一个文件可能在某些页面同步加载，在另外一些页面异步加载，如何判断这个文件是同步还是异步呢？可以采取同步优先或者pv高优先的策略。

同步优先认为只要是同步加载认为是同步的资源；pv优先认为在哪种情况下使用多久认为是什么资源。

计算打包的时候默认将同步和异步资源分开打包，也可以通过配置不区分同步异步。